{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
    <h4>MATRIZ DE DECIS√ÉO: COMPRA DO GADO</h4>
    <span>Simula√ß√£o de Compra do Gado</span>
{% endblock title %}

{% block customcss %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            color: #333;
        }
        /* Novo container para o cabe√ßalho superior */
        .top-header-container {
            display: flex;
            gap: 20px; /* Mesma lacuna do main-container para alinhamento visual */
            margin-bottom: 15px;
            align-items: center; /* Alinha verticalmente os itens */
        }
        .top-header-column {
            flex: 1; /* Permite que as colunas cres√ßam */
        }
        .top-header-column.select-area {
            /* Largura da coluna do select deve corresponder √† largura da coluna da matriz abaixo */
            max-width: 100%; /* Ajuste com base no gap */
            background-color: #004080; /* Fundo azul do cabe√ßalho */
            color: #fff;
            padding: 8px 15px;
            border-radius: 4px;
            display: flex; /* Para alinhar label e select */
            align-items: center;
            gap: 10px;
        }
        .top-header-column.select-area label {
            margin: 0;
            font-size: 0.9rem;
            white-space: nowrap; /* Impede a quebra de linha aqui */
        }
        .top-header-column.select-area select {
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            width: 100%; /* Faz o select ocupar o espa√ßo restante */
        }

        .top-header-column.description-area {
            /* Largura da coluna da descri√ß√£o deve corresponder √† largura da coluna do simulador abaixo */
            max-width: calc(35% - 10px); /* Ajuste com base no gap */
            display: flex;
            align-items: center;
            gap: 10px;
            /* ADICIONADO: Estilos para a cor de fundo e padding */
            background-color: #004080;
            color: #fff;
            padding: 8px 15px; /* Mesmo padding do select-area */
            border-radius: 4px; /* Mesmo border-radius */
        }
        .top-header-column.description-area label { /* Removida do HTML, mas mantendo o estilo caso precise re-adicionar */
            margin-bottom: 0;
            font-weight: bold;
            white-space: nowrap;
        }
        .top-header-column.description-area input {
            flex-grow: 1; /* Faz o input ocupar o m√°ximo de espa√ßo */
            /* Ajuste o estilo do input para se adequar ao fundo escuro */
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .top-header-column.description-area button {
            white-space: nowrap; /* Evita quebra de linha do bot√£o */
            padding: 6px 12px;
            font-size: 0.85rem;
            /* Cor do bot√£o conforme a imagem (parece um tom de verde/azul mais claro) */
            background-color: #5cb85c; /* Ou um tom mais pr√≥ximo da imagem, tipo #4CAF50 ou #4CAF50 */
            border-color: #5cb85c;
            color: #fff;
        }


        /* Estilos existentes (n√£o alterados aqui, apenas para contexto) */
        .main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .card-column {
            flex: 1;
            min-width: 450px;
        }
        .card-column.matriz {
            max-width: 60%;
        }
        .card-column.simulador {
            max-width: 40%;
        }

        table.simulacao, table.lucratividade {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        table.simulacao th, table.simulacao td,
        table.lucratividade th, table.lucratividade td {
            border: 1px solid #cce0f0;
            padding: 4px 8px;
            text-align: left;
            vertical-align: middle;
        }
        table.simulacao thead th, table.lucratividade thead th {
            background-color: #004080;
            color: #fff;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            text-align: center;
            padding: 8px 10px;
        }
        table.simulacao tbody th {
            background-color: #d9e2ef;
            text-align: center;
            font-weight: bold;
            color: #004080;
        }
        table.lucratividade tbody th {
            background-color: #e6f0fa;
            font-weight: normal;
        }
        table.simulacao td input,
        table.simulacao td select,
        table.lucratividade td input,
        table.lucratividade td select {
            width: 100%;
            font-size: 0.8rem;
            padding: 3px 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #fff;
        }
        table.simulacao td input:focus,
        table.simulacao td select:focus,
        table.lucratividade td input:focus,
        table.lucratividade td select:focus {
            border-color: #007bff;
            outline: none;
        }
        table.simulacao td, table.lucratividade td {
            text-align: right;
            padding-right: 5px;
        }
        table.simulacao td.text-left, table.lucratividade td.text-left {
            text-align: left;
            padding-right: 8px;
        }
        table.simulacao td.text-center, table.lucratividade td.text-center {
            text-align: center;
        }
        .static-value {
            background-color: #e6f0fa;
            font-weight: bold;
            padding: 3px 5px;
            border-radius: 3px;
            display: block;
            text-align: right;
        }
        .profit-negative {
            color: #e74c3c;
            font-weight: bold;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .recommendation-box {
            background-color: #cfe2f3;
            border: 1px solid #9fc5e8;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: #004080;
            border-radius: 4px;
        }
        .potential-economy-box {
            margin-top: 15px;
            border: 1px solid #cce0f0;
            border-collapse: collapse;
        }
        .potential-economy-box table {
            width: 100%;
            border-collapse: collapse;
        }
        .potential-economy-box th, .potential-economy-box td {
            border: 1px solid #cce0f0;
            padding: 4px 8px;
            text-align: right;
            font-size: 0.8rem;
        }
        .potential-economy-box th {
            background-color: #e6f0fa;
            font-weight: bold;
            text-align: left;
        }
        .potential-economy-box .header {
            background-color: #004080;
            color: #fff;
            font-weight: bold;
            text-align: center;
            padding: 6px 0;
            font-size: 0.85rem;
        }
        .potential-economy-box td.label {
            text-align: left;
            font-weight: bold;
            background-color: #e6f0fa;
        }
        .potential-economy-box td.value {
            text-align: right;
        }
        .potential-economy-box tfoot td {
            font-weight: bold;
            background-color: #f0f8ff;
        }
        .divider {
            border-bottom: 1px dashed #aaa;
            margin: 10px 0;
        }
        .label-value-pair {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .label-value-pair span {
            font-size: 0.75rem;
            color: #555;
        }
        .label-value-pair .value-input {
            flex-grow: 1;
            margin-left: 5px;
        }
        .label-value-pair input {
            width: calc(100% - 40px);
        }
        .dual-value-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .dual-value-cell input {
            width: 100%;
        }
        .select-auto-height {
            height: auto !important; /* For√ßa a altura a ser autom√°tica */
        }
        
    </style>
{% endblock customcss %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="#">Matriz de Decis√£o: Compra de Gado</a></li>
{% endblock breadcrumb %}

{% block content %}
<form method="post" action="" class="form-material">
    {% csrf_token %}
    {{ form.icms_debit_value }}
    {{ form.icms_credit_value }}     
    {{ form.granted_credit_value }} 
    {{ form.icms_loss_reversal_value }} 
    {{ form.protege_value }} 
    {{ form.fundeinfra_value }}    
    <div class="top-header-container">
        <div class="top-header-column select-area">
            {% comment %} <label for="id_cow_weighing_location">Local de Pesagem</label>
            {{ form.cow_weighing_location }} {% endcomment %}
            {% render_field form.description class="form-control" placeholder="Ex: Compra Julho - Gado PO" %}
            <button type="submit" class="btn btn-primary">Salvar Simula√ß√£o</button>            
        </div>
    </div>

    <div class="main-container">
        <div class="card-column matriz">
            <div class="card">
                <div class="card-block">
                    <table class="simulacao">
                        <thead>
                            <tr>
                                <th colspan="3" class="text-center">MATRIZ DE DECIS√ÉO: COMPRA DO GADO</th>
                                <th class="text-center">Produtor Rural</th>
                                <th class="text-center">Frigor√≠fico</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-left" style=" font-weight: bold;" rowspan="3">Volume de Venda</td>
                                <td class="text-center" colspan="2" style="">Kg / M√™s</td>
                                <td>{{ form.monthly_sales_volume_kg|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>
                            <tr>
                                {# A primeira <td> desta linha foi removida, pois a <td> acima com rowspan j√° a cobre #}
                                <td class="text-center" colspan="2">R$ / M√™s</td>
                                <td>{{ form.total_sales_per_month|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>
                            <tr>
                                {# A primeira <td> desta linha tamb√©m foi removida #}
                                <td class="text-center" colspan="2">R$ / Kg</td>
                                <td>{{ form.average_price_per_kg|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="font-weight: bold;">Quantidade</td>
                                <td class="text-left" style="">Vacas - M√™s</td>
                                <td class="text-center" style="">Unid</td>
                                <td>{{ form.cows_per_month_producer|add_class:"text-center" }}</td>
                                <td>{{ form.cows_per_month_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>
                            <tr>

                                <td class="text-left">Vacas - Semana</td>
                                <td class="text-center">Unid</td>
                                <td>{{ form.cows_per_week_producer|add_class:"text-center" }}</td>
                                <td>{{ form.cows_per_week_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="background-color: #fff; font-weight: bold;">Peso</td>
                                <td class="text-left" rowspan="2" style="background-color: #fff;">M√©dio por Vaca</td>
                                <td class="text-center" style="background-color: #fff;">Arroba</td>
                                <td>{{ form.mean_weight_per_cow_producer_arroba|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.mean_weight_per_cow_slaughterhouse_arroba|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-center">Kg</td>
                                <td>{{ form.mean_weight_per_cow_producer_kg|add_class:"text-center" }}</td>
                                <td>{{ form.mean_weight_per_cow_slaughterhouse_kg|add_class:"text-center" }}</td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="background-color: #fff; font-weight: bold;">Rendimento</td>
                                <td class="text-left" style="background-color: #fff;">Vaca em P√© (no pasto)</td>
                                <td class="text-center" style="background-color: #fff;">%</td>
                                <td>{{ form.yield_live_cow_pasture_producer_percent|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.yield_live_cow_pasture_slaughterhouse_percent|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-left">Vaca Casada</td>
                                <td class="text-center">%</td>
                                <td>{{ form.yield_butchered_cow_producer_percent|add_class:"text-center" }}</td>
                                <td>{{ form.yield_butchered_cow_slaughterhouse_percent|add_class:"text-center" }}</td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="background-color: #fff; font-weight: bold;">Pre√ßo</td>
                                <td class="text-left" style="background-color: #fff;">Bruto no pasto</td>
                                <td class="text-center" style="background-color: #fff;">R$ / Arroba</td>
                                <td>{{ form.price_closed_per_arroba_producer|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.price_closed_per_arroba_slaughterhouse|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-left">L√≠quido</td>
                                <td class="text-center">R$ / Arroba</td>
                                <td>{{ form.price_net_per_arroba_producer|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.price_net_per_arroba_slaughterhouse|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="background-color: #fff; font-weight: bold;">Pre√ßo</td>
                                <td class="text-left" style="background-color: #fff;">Vaca Casada</td>
                                <td class="text-center" style="background-color: #fff;">R$ / Kg</td>
                                <td>{{ form.price_per_kg_butchered_cow_producer|add_class:"text-center" }}</td>
                                <td>{{ form.price_per_kg_butchered_cow_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>
                            <tr>
                                <td class="text-left">P√≥s Desossa</td>
                                <td class="text-center">R$ / Kg</td>
                                <td>{{ form.price_per_kg_after_butchered_cow_producer|add_class:"text-center" }}</td>
                                <td>{{ form.price_per_kg_after_butchered_cow_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>

                            <tr>
                                <td class="text-left" style="background-color: #fff; font-weight: bold;">Servi√ßo</td>
                                <td class="text-left" style="background-color: #fff;">Abate por Vaca</td>
                                <td class="text-center" style="background-color: #fff;">R$</td>
                                <td>{{ form.slaughter_service_per_cow_producer|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.slaughter_service_per_cow_slaughterhouse|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>

                            <tr>
                                <td class="text-left" rowspan="2" style="background-color: #fff; font-weight: bold;">Frete:</td>
                                <td class="text-left" style="background-color: #fff;">Produtor - Frigor√≠fico</td>
                                <td class="text-center" style="background-color: #fff;">R$</td>
                                <td>{{ form.freight_producer_slaughterhouse_producer|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="text-left">Frigor√≠fico - Supermercado</td>
                                <td class="text-center">R$</td>
                                <td>{{ form.freight_slaughterhouse_store_producer|add_class:"text-center" }}</td>
                                <td>
                                    {% comment %} {{ form.freight_slaughterhouse_store_slaughterhouse|add_class:"text-center" }} {% endcomment %}
                                </td>
                            </tr>

                            <tr>
                                <td class="text-left" style="background-color: #e6f0fa; font-weight: bold;">M√£o de Obra</td>
                                <td class="text-center" style="background-color: #e6f0fa;">
                                    <div style="display: flex; align-items: center; justify-content: center;">
                                        <span style="margin-right: 5px;">Comiss√£o Comprador</span>
                                        {{ form.percent_comission|add_class:"text-center small-input" }}
                                    </div>
                                </td>
                                <td class="text-center" style="background-color: #e6f0fa;">
                                    Montante R$
                                </td>
                                <td>{{ form.commission_buyer|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>

                            <tr>
                                <td class="text-left" style="background-color: #e6f0fa; font-weight: bold;">Servi√ßo</td>
                                <td class="text-left" style="background-color: #e6f0fa;">Abate por Vaca</td>
                                <td class="text-center" style="background-color: #e6f0fa;">
                                    Montante R$
                                </td>
                                <td>{{ form.total_slaughter_cost|add_class:"text-center" }}</td>
                                <td></td>
                            </tr>

                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Fretes</td>
                                <td class="text-center" style="background-color: #e6f0fa;">
                                    Montante R$
                                </td>
                                <td>    
                                    <input type="text"
                                        id="id_frete_total_produtor"
                                        value="0"
                                        class="form-control text-center"
                                        readonly>
                                </td>
                                <td>
                                    {% comment %} <input type="text"
                                        id="id_frete_total_frigorifico"
                                        value="0"
                                        class="form-control text-center"
                                        readonly> {% endcomment %}
                                </td>
                            </tr>                            

                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Valor Total Compra</td>
                                <td class="text-center" style="background-color: #e6f0fa;">Montante R$</td>
                                <td>{{ form.total_value_producer|add_class:"text-center" }}</td>
                                <td>{{ form.total_value_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>

                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Valor Total</td>
                                <td class="text-center" style="background-color: #e6f0fa;">Montante R$</td>
                                <td>
                                    {{ form.total_value_producer_total|add_class:"text-center" }}
                                    <input type="text"
                                        id="id_total_value_producer_total"
                                        value="0"
                                        class="form-control text-center"
                                        readonly>                            
                                </td>
                                <td>
                                    <input type="text"
                                        id="id_total_value_slaughterhouse_total"
                                        value="0"
                                        class="form-control text-center"
                                        readonly>     
                                </td>
                            </tr>                            

                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Ganho Potencial na Compra (Produtor x Frigor√≠fico)</td>
                                <td class="text-center" style="background-color: #e6f0fa;">Montante R$</td>
                                <td colspan="2" class="text-center">
                                    {{ form.profit_gain_comparison|add_class:"text-center" }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card-column simulador">
            <div class="card">
                <div class="card-block">
                    <table class="lucratividade">
                        <thead>
                            <tr>
                                <th colspan="4" class="text-center">SIMULADOR DE LUCRATIVIDADE</th>
                            </tr>
                            <tr>
                                <th class="text-center" colspan="2" style="width: 65%;">Drivers</th>
                                <th class="text-center">Produtor Rural</th>
                                <th class="text-center">Frigor√≠fico</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center divider"></td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">ICMS D√©bito 12%</td>
                                <td>{{ form.icms_debit_producer|add_class:"text-center" }}</td>
                                <td>{{ form.icms_debit_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Cr√©dito 12%</td>
                                <td></td>
                                <td>{{ form.icms_credit_slaughterhouse|add_class:"text-center" }}</td>
                            </tr>
                             <tr>
                                <td colspan="4" class="text-center divider"></td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Cr√©dito Outorgado 9%</td>
                                <td>
                                    {{ form.granted_credit_percent|add_class:"text-center" }}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        {# O texto do label #}
                                        <span>Estorno ICMS da Perda 12%</span>
                                        
                                        {# O select do formul√°rio #}
                                        {{ form.is_estorno_icms|add_class:"select-auto-height" }}
                                    </div>
                                </td>
                                <td></td>
                                <td>
                                    {{ form.icms_loss_reversal_percent|add_class:"text-center" }}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">PROTEGE 1,35%</td>
                                <td>
                                    {{ form.protege_percent|add_class:"text-center" }}
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">
                                    FUNDEINFRO <span id="fundeinfra-display"></span>
                                </td>
                                <td>
                                    {{ form.fundeinfra_percent|add_class:"text-center" }}
                                </td>
                                <td></td>
                            </tr>
                             <tr>
                                <td colspan="4" class="text-center divider"></td>
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Impostos Efetivos</td>
                                <td>
                                    <span class="dual-value-cell">
                                        {{ form.tax_producer_real|add_class:"text-center" }}
                                        {{ form.tax_producer_percent|add_class:"text-center" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="dual-value-cell">
                                        {{ form.tax_slaughterhouse_real|add_class:"text-center" }}
                                        {{ form.tax_slaughterhouse_percent|add_class:"text-center" }}
                                    </span>                                    
                                </td>                                
                            </tr>
                            <tr>
                                <td class="text-left" colspan="2" style="background-color: #e6f0fa; font-weight: bold;">Margem de Lucro Efetiva</td>
                                <td>
                                    <span class="dual-value-cell">
                                        {{ form.profit_producer_real|add_class:"text-center" }}
                                        {{ form.profit_producer_percent|add_class:"text-center" }}
                                    </span>
                                </td>
                                <td>
                                    <span class="dual-value-cell">
                                        {{ form.profit_slaughterhouse_real|add_class:"text-center" }}
                                        {{ form.profit_slaughterhouse_percent|add_class:"text-center" }}
                                    </span>                                    
                                </td>                                
                            </tr>                            
                        </tbody>
                    </table>
                    <div class="potential-economy-box">
                        <div class="header">MELHOR OP√á√ÉO</div>
                    </div>
                    <div class="recommendation-box">
                        <div class="col-md-12 text-center" id="melhor_opcao_container">
                            <h4 id="melhor_opcao" class="font-weight-bold py-2">Frigor√≠fico</h4>                            
                        </div>   
                    </div>

                    <div class="divider"></div>
                    <div class="divider"></div>

                    <div class="potential-economy-box">
                        <div class="header">ECONOMIA POTENCIAL</div>
                        <table>
                            <tbody>
                                <tr>
                                    <td class="text-center" style="background-color: #e6f0fa; font-weight: bold;">Mensal</td>
                                    <td class="text-center" style="background-color: #e6f0fa; font-weight: bold;">Anual</td>
                                    <td class="text-center" style="background-color: #e6f0fa; font-weight: bold;">Arroba</td>
                                    <td class="text-center" style="background-color: #e6f0fa; font-weight: bold;">Kg</td>
                                </tr>
                                <tr>
                                    <td>{{ form.economia_mensal }}</td>
                                    <td>{{ form.economia_anual }}</td>
                                    <td>{{ form.economia_arroba }}</td>
                                    <td>{{ form.economia_kg }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock content %}

{% block anotherjs %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/autonumeric@4.6.0"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const el = document.getElementById('id_fundeinfra_value');
        if (el) {
            const valor = parseFloat(el.value);
            if (!isNaN(valor)) {
                document.getElementById('fundeinfra-display').textContent = (valor).toFixed(2).replace('.', ',') + '%';
            }
        }
        // Adiciona o evento de tecla Enter para avan√ßar para o pr√≥ximo campo        
        const formElements = document.querySelectorAll('input, select');
        formElements.forEach(element => {
            element.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    event.preventDefault();
                    const currentIndex = Array.from(formElements).indexOf(this);
                    const nextIndex = currentIndex + 1;
                    if (nextIndex < formElements.length) {
                        formElements[nextIndex].focus();
                    }
                }
            });
        });
    });
</script>

<script>
    $(document).ready(function () {
        $('.select2').select2();

        const percentOptions = {
            suffixText: ' %',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 2
        };

        // AutoNumeric para percentuais
        const yieldButcheredProducer = new AutoNumeric('#id_yield_butchered_cow_producer_percent', percentOptions);
        const yieldButcheredSlaughterhouse = new AutoNumeric('#id_yield_butchered_cow_slaughterhouse_percent', percentOptions);
        const yieldLive = new AutoNumeric('#id_yield_live_cow_pasture_producer_percent', percentOptions);
        const percentComission = new AutoNumeric('#id_percent_comission', percentOptions);
        
        // AutoNumeric para n√∫meros e valores
        const volume = new AutoNumeric('#id_monthly_sales_volume_kg', {
            currencySymbol: '',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 0
        });

        const totalFreteProdutor = new AutoNumeric('#id_frete_total_produtor', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 2,
            readOnly: true
        });
        
        /*
        const totalFreteFrigorifico = new AutoNumeric('#id_frete_total_frigorifico', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 2,
            readOnly: true
        });      
        */

        const totalVenda = new AutoNumeric('#id_total_sales_per_month', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 2,
            readOnly: true
        });

        const precoMedio = new AutoNumeric('#id_average_price_per_kg', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',',
            digitGroupSeparator: '.',
            decimalPlaces: 2
        });

        const pesoFrigorificoKg = new AutoNumeric('#id_mean_weight_per_cow_slaughterhouse_kg', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });

        const pesoProdutorArroba = new AutoNumeric('#id_mean_weight_per_cow_producer_arroba', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const cowsMonthProducer = new AutoNumeric('#id_cows_per_month_producer', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const cowsMonthSlaughterhouse = new AutoNumeric('#id_cows_per_month_slaughterhouse', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const cowsWeekProducer = new AutoNumeric('#id_cows_per_week_producer', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const cowsWeekSlaughterhouse = new AutoNumeric('#id_cows_per_week_slaughterhouse', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const pricePerKgButcheredCowProducer = new AutoNumeric('#id_price_per_kg_butchered_cow_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });   
        
        const priceBrutoProducer = new AutoNumeric('#id_price_closed_per_arroba_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });

        const priceNetProducer = new AutoNumeric('#id_price_net_per_arroba_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const pricePerKgAfterButcheredCowProducer = new AutoNumeric('#id_price_per_kg_after_butchered_cow_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });   
        
        const pricePerKgButcheredCowSlaughterhouse = new AutoNumeric('#id_price_per_kg_butchered_cow_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });
        
        const pricePerKgAfterButcheredCowSlaughterhouse = new AutoNumeric('#id_price_per_kg_after_butchered_cow_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const slaughterServicePerCowProducer = new AutoNumeric('#id_slaughter_service_per_cow_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });

        /*
        const slaughterServicePerCowSlaughterhouse = new AutoNumeric('#id_slaughter_service_per_cow_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });     
        */
        
        const freightProducerSlaughterhouseProducer = new AutoNumeric('#id_freight_producer_slaughterhouse_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });     

        const freightSlaughterhouseStoreProducer = new AutoNumeric('#id_freight_slaughterhouse_store_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });  
        
        /*
        const freightSlaughterhouseStoreSlaughterhouse = new AutoNumeric('#id_freight_slaughterhouse_store_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2
        });  
        */
        
        const totalValueProducer = new AutoNumeric('#id_total_value_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const totalProducer = new AutoNumeric('#id_total_value_producer_total', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });
        
        const totalSlaughterhouse = new AutoNumeric('#id_total_value_slaughterhouse_total', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });               

        const commissionBuyer = new AutoNumeric('#id_commission_buyer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const totalValueSlaughterhouse = new AutoNumeric('#id_total_value_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });    
        
        const totalSlaughterCost = new AutoNumeric('#id_total_slaughter_cost', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });  

        const profitGainComparison = new AutoNumeric('#id_profit_gain_comparison', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const icmsCredit = parseFloat($('#id_icms_credit_value').val().replace(',', '.')) || 0;
        const icmsDebit = parseFloat($('#id_icms_debit_value').val().replace(',', '.')) || 0;

        const icmsCreditoSlaughterhouse = new AutoNumeric('#id_icms_credit_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const icmsDebitoProdutor = new AutoNumeric('#id_icms_debit_producer', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });        

        const protegeField = new AutoNumeric('#id_protege_percent', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });  
        
        const fundeinfraField = new AutoNumeric('#id_fundeinfra_percent', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });    
        
        const grantedCreditPercent = new AutoNumeric('#id_granted_credit_percent', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const taxProducerReal = new AutoNumeric('#id_tax_producer_real', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });  
        
        const taxProducerPercent = new AutoNumeric('#id_tax_producer_percent', percentOptions);  
        
        const icmsDebitoFrigorifico = new AutoNumeric('#id_icms_debit_slaughterhouse', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        }); 
        
        const icmsLossReversalPercent = new AutoNumeric('#id_icms_loss_reversal_percent', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });   
         
        const taxSlaughterhouseReal = new AutoNumeric('#id_tax_slaughterhouse_real', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });  
        
        const taxSlaughterhousePercent = new AutoNumeric('#id_tax_slaughterhouse_percent', percentOptions);

        const profitProducerReal = new AutoNumeric('#id_profit_producer_real', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        }); 
        
        const profitProducerPercent = new AutoNumeric('#id_profit_producer_percent', percentOptions);

        const profitSlaughterhouseReal = new AutoNumeric('#id_profit_slaughterhouse_real', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const profitSlaughterhousePercent = new AutoNumeric('#id_profit_slaughterhouse_percent', percentOptions);

        const economiaMensal = new AutoNumeric('#id_economia_mensal', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        }); 
        
        const economiaAnual = new AutoNumeric('#id_economia_anual', {
            currencySymbol: 'R$ ',
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });     
        
        const economiaKg = new AutoNumeric('#id_economia_kg', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });

        const economiaArroba = new AutoNumeric('#id_economia_arroba', {
            decimalCharacter: ',', digitGroupSeparator: '.', decimalPlaces: 2,
            readOnly: true
        });
        
        function calcularLucroComparativo() {
            const j34 = totalValueSlaughterhouse.getNumber();
            const h34 = totalValueProducer.getNumber();
            const h32 = totalSlaughterCost.getNumber();
            const h30 = commissionBuyer.getNumber();
            const j40 = totalProducer.getNumber();
            const i40 = totalSlaughterhouse.getNumber();
        
            if (j34 > 0 && h34 >= 0 && h32 >= 0 && h30 >= 0) {
                const resultado = i40 - j40;
                profitGainComparison.set(resultado);
            } else {
                profitGainComparison.set(0);
            }
        }        
        
        function calcularCustoTotalAbate() {
            const h10 = cowsMonthProducer.getNumber(); // peso produtor arroba
            const h25 = slaughterServicePerCowProducer.getNumber(); // servi√ßo por vaca

            if (h10 > 0 && h25 > 0) {
                const resultado = h10 * h25;
        
                totalSlaughterCost.set(resultado);
            } else {
                totalSlaughterCost.set(0);
            }
            calcularValorTotalProdutorTotal();
        }        
        
        function calcularComissaoComprador() {
            const total = totalValueProducer.getNumber();
            const percent = percentComission.getNumber() / 100; // Convertendo para decimal
        
            if (total > 0) {
                const resultado = total * percent;
                commissionBuyer.set(resultado);
            } else {
                commissionBuyer.set(0);
            }
        }   
        
        function calcularValorTotalFrigorifico() {
            const f6 = volume.getNumber();
            const j17 = yieldButcheredSlaughterhouse.getNumber() / 100;
            const j22 = pricePerKgButcheredCowSlaughterhouse.getNumber();
        
            if (f6 > 0 && j17 > 0 && j22 > 0) {
                const resultado = (f6 / j17) * j22;
                totalValueSlaughterhouse.set(resultado);
            } else {
                totalValueSlaughterhouse.set(0);
            }
            calcularValorTotalFrigorificoTotal();
        }   
        
        function calcularValorTotalFrigorificoTotal(){
            const h34 = totalValueSlaughterhouse.getNumber();
            // const i36 = totalFreteFrigorifico.getNumber(); 
            const i36 = 0;
        
            const resultado = h34 + i36;
            totalSlaughterhouse.set(resultado);    
            
            calcularLucroComparativo();
        }

        function calcularPesoProdutorArroba() {
            const pesoKg = pesoFrigorificoKg.getNumber();
            if (pesoKg > 0) {
                const pesoArroba = pesoKg / 15;
                pesoProdutorArroba.set(pesoArroba);
                calcularQtdVacasMesProdutor();
            } else {
                pesoProdutorArroba.set(0);
                calcularQtdVacasMesProdutor();
            }
        }

        function calcularQtdVacasMesProdutor() {
            // const t4 = $('#id_cow_weighing_location').val();  // 'campo' ou 'frigorifico'
            const t4 = 'campo'; // For√ßando o valor para teste, remova esta linha na produ√ß√£o
            const f6 = volume.getNumber(); // monthly_sales_volume_kg
            const i17 = yieldButcheredProducer.getNumber() / 100; 
            const j17 = yieldButcheredSlaughterhouse.getNumber() / 100;
            const h16 = yieldLive.getNumber() / 100;
            const h13 = pesoProdutorArroba.getNumber(); // peso m√©dio por vaca em arrobas
        
            // Verifica se os valores necess√°rios foram preenchidos
            if (f6 > 0 && i17 > 0 && j17 > 0 && h16 > 0 && h13 > 0) {
                let base = (f6 / i17) / h16;
                let resultado;
        
                if (t4 === 'campo') {
                    // üêÑ Pesagem no campo ‚Üí divide por 15 para converter kg -> arroba
                    resultado = (base / 15) / h13;
                } else if (t4 === 'frigorifico') {
                    // üè≠ Pesagem no frigor√≠fico ‚Üí considera diretamente em arrobas
                    resultado = base / h13;
                } else {
                    // Valor inesperado para t4
                    resultado = 0;
                }
        
                // Preenche campos
                cowsMonthProducer.set(resultado);
                cowsMonthSlaughterhouse.set(resultado);
                cowsWeekProducer.set(resultado / 4);
                cowsWeekSlaughterhouse.set(resultado / 4);
            } else {
                // Zera os campos se os valores forem inv√°lidos
                cowsMonthProducer.set(0);
                cowsMonthSlaughterhouse.set(0);
                cowsWeekProducer.set(0);
                cowsWeekSlaughterhouse.set(0);
            }
        }
        

        function calcularTotalVendaMes() {
            const qtd = volume.getNumber();
            const preco = precoMedio.getNumber();
            if (qtd > 0 && preco > 0) {
                totalVenda.set(qtd * preco);
            } else {
                totalVenda.set(0);
            }
        }
        
        function calcularPrecoLiquidoArrobaProdutor() {
            const bruto = priceBrutoProducer.getNumber();
            const rendimento = yieldLive.getNumber() / 100;
        
            if (bruto > 0 && rendimento >= 0) {
                const liquido = bruto * (1 - rendimento);
                priceNetProducer.set(liquido);
            } else {
                priceNetProducer.set(0);
            }
        }

        function calcularPrecoPorKgVacaCasadaProdutor() {
            const priceNet = priceNetProducer.getNumber(); // Assumindo que este √© o 'priceNetProducer'
            const pesoProdutor = pesoProdutorArroba.getNumber(); // Assumindo que este √© o 'pesoProdutorArroba'
            const pesoFrigorifico = pesoFrigorificoKg.getNumber(); // Assumindo que este √© o 'pesoFrigorificoKg'
            const yieldLivePercent = yieldLive.getNumber(); // Assumindo que este √© o 'yieldLive'
        
            const yieldLiveDecimal = yieldLivePercent / 100;
        
            // Verifica√ß√£o para evitar divis√£o por zero ou resultados inv√°lidos
            if (pesoFrigorifico > 0 && yieldLiveDecimal > 0) {
                const resultado = (priceNet * pesoProdutor) / (pesoFrigorifico * yieldLiveDecimal);
                pricePerKgButcheredCowProducer.set(resultado);
            } else {
                pricePerKgButcheredCowProducer.set(0);
            }
        } 
        
        function calcularPrecoKgDepoisVacaCasadaProdutor() {
            const precoKgAntes = pricePerKgButcheredCowProducer.getNumber();
            const rendimentoCasada = yieldButcheredProducer.getNumber() / 100;
        
            if (precoKgAntes > 0 && rendimentoCasada > 0) {
                const precoFinal = precoKgAntes / rendimentoCasada;
                pricePerKgAfterButcheredCowProducer.set(precoFinal);
            } else {
                pricePerKgAfterButcheredCowProducer.set(0);
            }
        }   
        
        function calcularPrecoKgDepoisVacaCasadaFrigorifico() {
            const precoKg = pricePerKgButcheredCowSlaughterhouse.getNumber();
            const rendimento = yieldButcheredSlaughterhouse.getNumber() / 100;
        
            if (precoKg > 0 && rendimento > 0) {
                const resultado = precoKg / rendimento;
                pricePerKgAfterButcheredCowSlaughterhouse.set(resultado);
            } else {
                pricePerKgAfterButcheredCowSlaughterhouse.set(0);
            }
        }

        function calcularValorTotalProdutor() {
            const h19 = priceBrutoProducer.getNumber(); // Pre√ßo fechado por arroba
            const f6 = volume.getNumber();              // Volume de vendas (Kg/m√™s)
            const h17 = yieldButcheredProducer.getNumber() / 100; // Rendimento (em decimal)
        
            if (h19 > 0 && f6 > 0 && h17 > 0) {
                const resultado = (h19 / 15) * (f6 / h17);
                totalValueProducer.set(resultado);
            } else {
                totalValueProducer.set(0);
            }     
            calcularValorTotalProdutorTotal();      
        }

        function calcularValorTotalProdutorTotal() {
            const h34 = totalValueProducer.getNumber();
            const h30 = commissionBuyer.getNumber();
            const h32 = totalSlaughterCost.getNumber();
            const i36 = totalFreteProdutor.getNumber(); 
        
            if (h34 > 0 && h30 >= 0 && h32 >= 0) {
                const resultado = h34 + (h30 + h32) + i36;
                totalProducer.set(resultado);
            } else {
                totalProducer.set(0);
            }
            calcularLucroComparativo();
            
        }

        function calcularIcmsDebitoProdutor() {
            const f7 = totalVenda.getNumber(); // campo total_sales_per_month
            const n7 = parseFloat($('#id_icms_debit_value').val().replace(',', '.')) / 100 || 0;
        
            const resultado = f7 * n7;          
        
            icmsDebitoProdutor.set(resultado);
            icmsDebitoFrigorifico.set(resultado);
        }

        function calcularIcmsCreditoFrigorifico() {
            const f6 = volume.getNumber();
            const j17 = yieldButcheredSlaughterhouse.getNumber() / 100;
            const j22 = pricePerKgButcheredCowSlaughterhouse.getNumber();
            const n8 = icmsCredit / 100 || 0;
        
            const resultado = (j17 > 0) ? ((f6 / j17) * j22) * n8 : 0;
        
            icmsCreditoSlaughterhouse.set(resultado);
        }

        function calcularCreditoOutorgado() {
            const f7 = totalVenda.getNumber();
            const n10 = parseFloat($('#id_granted_credit_value').val().replace(',', '.')) / 100 || 0;
        
            const resultado = f7 * n10;
        
            grantedCreditPercent.set(resultado);
        }

        function calcularEstornoIcmsPerda() {
            const isEstornoIcms = $('#id_is_estorno_icms').val(); // Pega o valor do select ('True' ou 'False' como string)
        
            if (isEstornoIcms === 'True') { // Se o valor selecionado for 'True' (Sim)
                const r8 = icmsCreditoSlaughterhouse.getNumber();
                const n11_value = parseFloat($('#id_icms_loss_reversal_value').val().replace(',', '.')) || 0;
                const n11_percent = n11_value / 100; // Converte para decimal
        
                const resultado = r8 * n11_percent;
                icmsLossReversalPercent.set(resultado);
        
            } else { // Se o valor selecionado for 'False' (N√£o) ou qualquer outra coisa
                icmsLossReversalPercent.set(0); // Define o resultado como 0
            }
            calcularImpostoEfetivoFrigorificoReal();
        }        
        
        function calcularProtegePercent() {
            const f7 = totalVenda.getNumber();
            const n13 = $('#id_protege_value').val() / 100 || 0;
            const resultado = f7 * n13;
            protegeField.set(resultado);
        }

        function calcularFundeinfraPercent() {
            const h34 = totalValueProducer.getNumber();
            const n14 = parseFloat($('#id_fundeinfra_value').val().replace(',', '.')) / 100 || 0;
        
            const resultado = h34 * n14;
        
            fundeinfraField.set(resultado);
        } 
        
        function calcularImpostoEfetivoProdutorReal() {
            const p7 = icmsDebitoProdutor.getNumber();
            const p13 = protegeField.getNumber();
            const p14 = fundeinfraField.getNumber();
            const p10 = grantedCreditPercent.getNumber();

            //P7+P13+P14-P10
        
            if (p7 !== null && p13 !== null && p14 !== null && p10 !== null) {
                const resultado = p7 + p13 + p14 - p10;
                taxProducerReal.set(resultado);
            } else {
                taxProducerReal.set(0);
            }
        }

        function calcularImpostoEfetivoProdutorPercent() {
            const p16 = taxProducerReal.getNumber();
            const f7 = totalVenda.getNumber();
        
            if (p16 > 0 && f7 > 0) {
                const resultado = p16 / f7;
                taxProducerPercent.set(resultado * 100);
            } else {
                taxProducerPercent.set(0);
            }
        }

        function calcularImpostoEfetivoFrigorificoReal() {
            const r7 = icmsDebitoFrigorifico.getNumber();
            const r8 = icmsCreditoSlaughterhouse.getNumber();
            const r11 = icmsLossReversalPercent.getNumber();
        
            if (r7 !== null && r8 !== null && r11 !== null) {
                const resultado = r7 - r8 + r11;
                taxSlaughterhouseReal.set(resultado);
            } else {
                taxSlaughterhouseReal.set(0);
            }

            calcularImpostoEfetivoFrigorificoPercent();
            calcularLucroEfetivoFrigorificoReal();
        }

        function calcularImpostoEfetivoFrigorificoPercent() {
            const r16 = taxSlaughterhouseReal.getNumber();
            const f7 = totalVenda.getNumber();
        
            if (r16 > 0 && f7 > 0) {
                const resultado = r16 / f7;
                taxSlaughterhousePercent.set(resultado * 100);
            } else {
                taxSlaughterhousePercent.set(0);
            }
        }

        function calcularLucroEfetivoProdutorReal() {
            const f7 = totalVenda.getNumber();
            const p16 = taxProducerReal.getNumber();
            const h34 = totalValueProducer.getNumber();
            const h27 = freightProducerSlaughterhouseProducer.getNumber();
            const h28 = freightSlaughterhouseStoreProducer.getNumber();
            const h32 = totalSlaughterCost.getNumber();
            const h30 = commissionBuyer.getNumber();
        
            if ([f7, p16, h34, h27, h28, h32, h30].every(val => val !== null)) {
                const resultado = f7 - p16 - h34 - h27 - h28 - h32 - h30;
                profitProducerReal.set(resultado);
            } else {
                profitProducerReal.set(0);
            }
        }

        function calcularLucroEfetivoProdutorPercent() {
            const p19 = profitProducerReal.getNumber();
            const f7 = totalVenda.getNumber();
        
            if (p19 !== null && f7 > 0) {
                const resultado = p19 / f7;
                profitProducerPercent.set(resultado * 100);
            } else {
                profitProducerPercent.set(0);
            }
        }

        function calcularLucroEfetivoFrigorificoReal() {
            const f7 = totalVenda.getNumber();
            const r16 = taxSlaughterhouseReal.getNumber();
            // const j27 = freightSlaughterhouseStoreSlaughterhouse.getNumber();
            const j27 = 0; // Temporariamente definido como 0, pois n√£o est√° sendo usado
            const j34 = totalValueSlaughterhouse.getNumber();
        
            if ([f7, r16, j27, j34].every(val => val !== null)) {
                const resultado = f7 - r16 - j27 - j34;
                profitSlaughterhouseReal.set(resultado);
            } else {
                profitSlaughterhouseReal.set(0);
            }
            calcularLucroEfetivoFrigorificoPercent();
        }
        
        function calcularLucroEfetivoFrigorificoPercent() {
            const r19 = profitSlaughterhouseReal.getNumber();
            const f7 = totalVenda.getNumber();
        
            if (r19 !== null && f7 > 0) {
                const resultado = r19 / f7;
                profitSlaughterhousePercent.set(resultado * 100);
            } else {
                profitSlaughterhousePercent.set(0);
            }
            definirMelhorOpcao();
        }
        
        function definirMelhorOpcao() {
            const P19 = profitProducerReal.getNumber();
            const R19 = profitSlaughterhouseReal.getNumber();
            const F6 = volume.getNumber();
        
            const container = $('#melhor_opcao_container');
            const h4 = $('#melhor_opcao');
        
            if (P19 > R19) {
                h4.text("Produtor Rural");
                economiaMensal.set(P19 - R19);
                economiaAnual.set((P19 - R19) * 12);
        
                container
                    .removeClass('bg-primary bg-warning bg-success text-white text-dark')
                    .addClass('bg-success text-white');
                
            } else {
                h4.text("Frigor√≠fico");
                economiaMensal.set(R19 - P19);
                economiaAnual.set((R19 - P19) * 12);                
        
                container
                    .removeClass('bg-primary bg-warning bg-success text-white text-dark')
                    .addClass('bg-warning text-dark');
            }

            if (F6 > 0) {
                const economiaKgValue = economiaMensal.getNumber() / F6;
                economiaKg.set(economiaKgValue);

                const economiaArrobaValue = economiaKgValue * 15;
                economiaArroba.set(economiaArrobaValue);
            } else {
                economiaKg.set(0);
                economiaArroba.set(0);
            }
        }

        function calcularFreteTotalProdutor() {
            const h27 = freightProducerSlaughterhouseProducer.getNumber();
            const h28 = freightSlaughterhouseStoreProducer.getNumber();
        
            if (h27 !== null && h28 !== null) {
                const resultado = h27 + h28;
                totalFreteProdutor.set(resultado);
            } else {
                totalFreteProdutor.set(0);
            }
            calcularValorTotalProdutorTotal();
        }

        function calcularFreteTotalFrigorifico() {
            // const j27 = freightSlaughterhouseStoreSlaughterhouse.getNumber();
            const j27 = 0;
            /*
            if (j27 !== null) {
                totalFreteFrigorifico.set(j27);
            } else {
                totalFreteFrigorifico.set(0);
            }
            */
            calcularValorTotalFrigorificoTotal();
        }

        $('#id_is_estorno_icms')
        .on('change keyup', function () {
            calcularEstornoIcmsPerda();
        });        
         

        // Atualiza automaticamente ao alterar os campos envolvidos
        $('#id_price_closed_per_arroba_producer, #id_yield_live_cow_pasture_producer_percent, #id_yield_butchered_cow_producer_percent')
        .on('keyup change', function () {
            calcularPrecoLiquidoArrobaProdutor();
            calcularPrecoPorKgVacaCasadaProdutor();
            calcularPrecoKgDepoisVacaCasadaProdutor();
        });
        // Espelha o valor do produtor para o frigor√≠fico (butchered %)
        $('#id_yield_butchered_cow_producer_percent, #id_yield_butchered_cow_slaughterhouse_percent').on('change keyup', function () {
            const valor = yieldButcheredProducer.getNumber();
            // yieldButcheredSlaughterhouse.set(valor);
            calcularQtdVacasMesProdutor();
        });

        $('#id_cow_weighing_location, #id_monthly_sales_volume_kg, #id_yield_live_cow_pasture_producer_percent, #id_mean_weight_per_cow_producer_arroba')
        .on('change keyup', function () {
            calcularQtdVacasMesProdutor();
        });

        $('#id_mean_weight_per_cow_slaughterhouse_kg').on('change keyup', function () {
            calcularPesoProdutorArroba();
            calcularLucroEfetivoProdutorReal();
            calcularLucroEfetivoProdutorPercent();              
            definirMelhorOpcao();            
        });

        $('#id_monthly_sales_volume_kg, #id_average_price_per_kg').on('keyup change', function () {
            calcularTotalVendaMes();
            calcularIcmsDebitoProdutor();
            calcularCreditoOutorgado();
            calcularProtegePercent();
        });

        $('#id_price_per_kg_butchered_cow_slaughterhouse, #id_yield_butchered_cow_slaughterhouse_percent')
        .on('change keyup', function () {
            calcularPrecoKgDepoisVacaCasadaFrigorifico();
        });

        $('#id_price_closed_per_arroba_producer, #id_monthly_sales_volume_kg, #id_yield_butchered_cow_producer_percent, #id_percent_comission')
        .on('keyup change', function () {
            calcularValorTotalProdutor();
            calcularComissaoComprador();
            calcularLucroComparativo();
            calcularFundeinfraPercent();
            calcularImpostoEfetivoProdutorReal();
            calcularImpostoEfetivoProdutorPercent();
            calcularLucroEfetivoProdutorReal();
            calcularLucroEfetivoProdutorPercent();  
            definirMelhorOpcao();          
        });

        $('#id_monthly_sales_volume_kg, #id_yield_butchered_cow_slaughterhouse_percent, #id_price_per_kg_butchered_cow_slaughterhouse')
        .on('keyup change', function () {
            calcularValorTotalFrigorifico();
            calcularLucroComparativo();
        }); 
        
        $('#id_cow_weighing_location, #id_monthly_sales_volume_kg, #id_mean_weight_per_cow_producer_arroba, #id_slaughter_service_per_cow_producer')
        .on('change keyup', function () {
            calcularCustoTotalAbate();
            calcularLucroComparativo();
            calcularLucroEfetivoProdutorReal();
            calcularLucroEfetivoProdutorPercent();
            definirMelhorOpcao();
        });

        $('#id_monthly_sales_volume_kg, #id_yield_butchered_cow_slaughterhouse_percent, #id_price_per_kg_butchered_cow_slaughterhouse').on('keyup change', function () {
            calcularIcmsCreditoFrigorifico();
            calcularEstornoIcmsPerda();
            calcularImpostoEfetivoFrigorificoReal();
            calcularImpostoEfetivoFrigorificoPercent();
            calcularLucroEfetivoFrigorificoReal();
            calcularLucroEfetivoFrigorificoPercent();  
            definirMelhorOpcao();          
        });   
        
        $('#id_total_sales_per_month, #id_tax_producer_real, #id_total_value_producer, #id_freight_producer_slaughterhouse_producer, #id_freight_slaughterhouse_store_producer, #id_total_slaughter_cost, #id_commission_buyer')
        .on('keyup change', function () {
            calcularFreteTotalProdutor();
            calcularLucroEfetivoProdutorReal();
            calcularLucroEfetivoProdutorPercent();
            definirMelhorOpcao();
        });

        $('#id_total_sales_per_month, #id_tax_slaughterhouse_real, #id_freight_slaughterhouse_store_slaughterhouse, #id_total_value_slaughterhouse')
        .on('keyup change', function () {
            calcularFreteTotalFrigorifico();
            calcularLucroEfetivoFrigorificoReal();
            calcularLucroEfetivoFrigorificoPercent();
            definirMelhorOpcao();
        });
        
        // Inicializa√ß√£o
        calcularPrecoLiquidoArrobaProdutor();        
        calcularPesoProdutorArroba();
        calcularTotalVendaMes();
        calcularFreteTotalProdutor();
        calcularFreteTotalFrigorifico();
        calcularPrecoPorKgVacaCasadaProdutor();
        calcularPrecoKgDepoisVacaCasadaProdutor();
        calcularPrecoKgDepoisVacaCasadaFrigorifico();
        calcularValorTotalProdutor();
        calcularComissaoComprador();
        calcularValorTotalFrigorifico();
        calcularCustoTotalAbate();
        calcularIcmsDebitoProdutor();
        calcularIcmsCreditoFrigorifico();
        calcularCreditoOutorgado();
        calcularEstornoIcmsPerda();
        calcularProtegePercent();
        calcularFundeinfraPercent();
        calcularImpostoEfetivoProdutorReal();
        calcularImpostoEfetivoProdutorPercent();
        calcularImpostoEfetivoFrigorificoReal();
        calcularImpostoEfetivoFrigorificoPercent();   
        calcularLucroEfetivoFrigorificoReal();
        calcularLucroEfetivoFrigorificoPercent();  
        calcularLucroEfetivoProdutorReal();
        calcularLucroEfetivoProdutorPercent();               
        definirMelhorOpcao();

    });
</script>

{% endblock anotherjs %}
